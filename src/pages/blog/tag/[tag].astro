---
import BlogPostPreview from "@/components/BlogPostPreview.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import Header from "@/components/Header.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const allPosts = await getCollection("posts");

  const tagToPostsMap = new Map<string, typeof allPosts>();

  for (const post of allPosts) {
    for (const tag of post.data.tags) {
      if (!tagToPostsMap.has(tag)) {
        tagToPostsMap.set(tag, []);
      }
      tagToPostsMap.get(tag)?.push(post);
    }
  }

  return [...tagToPostsMap.entries()].map(([tag, posts]) => {
    return {
      params: { tag },
      props: { posts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;

const title = `Posts tagged with "${tag}" - pavi2410's blog`;
const description = `Explore ${posts.length} blog post${posts.length === 1 ? '' : 's'} about ${tag} by Pavitra Golchha. Topics include web development, programming, and technology.`;
const permalink = `/blog/tag/${tag}`;
---

<BaseLayout
  title={title}
  description={description}
  permalink={permalink}
  keywords={`${tag}, blog, pavi2410, Pavitra Golchha`}
>
  <Header />
  <div class="container mx-auto max-w-prose space-y-8 my-16">
    <h1 class="text-4xl font-bold mb-4">Posts tagged with "{tag}"</h1>
    <p class="text-lg opacity-80 mb-8">{posts.length} post{posts.length === 1 ? '' : 's'} found</p>
    <section class="flex flex-col gap-4 divide-y divide-neutral-500/50">
      {posts.map((post) => <BlogPostPreview post={post} />)}
    </section>
  </div>
</BaseLayout>
