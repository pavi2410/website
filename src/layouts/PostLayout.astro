---
import {
  formatDate,
  getReadingTime,
  pickColorByHash,
  pickColorGradientByHash,
} from "@/util";
import BaseLayout from "./BaseLayout.astro";
import Header from "@/components/Header.astro";
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";
import TableOfContents from "@/components/TableOfContents";
import CopyToMarkdown from "@/components/CopyToMarkdown";
import ShareButtons from "@/components/ShareButtons.astro";

export interface Props {
  frontmatter: CollectionEntry<"posts">["data"];
  headings?: { depth: number; slug: string; text: string }[];
  rawContent?: string;
}

const {
  frontmatter: { title, excerpt, publishDate, quickLinks, tags },
  rawContent,
} = Astro.props;

const permalink = Astro.url.pathname;
const fullUrl = new URL(permalink, Astro.site || "https://pavi2410.com").href;
const heroImage = "";
const alt = "";
const keywords = tags.join(", ");
const readingTime = rawContent ? getReadingTime(rawContent) : null;

// Get headings for TOC
const headings = Astro.props.headings || [];
---

<BaseLayout
  title={title}
  description={excerpt}
  permalink={permalink}
  publishDate={publishDate}
  keywords={keywords}
  type="article"
>
  <Header />

  <!-- Mobile TOC: sticky below main header -->
  <div
    class="xl:hidden sticky top-0 pt-[4.5rem] z-40 bg-neutral-50/95 dark:bg-neutral-950/95 backdrop-blur border-b border-neutral-200 dark:border-neutral-800"
  >
    <TableOfContents client:load headings={headings} collapsible />
  </div>

  <div class="blog-container">
    <article
      class="prose prose-lg dark:prose-invert max-lg:mx-8 mt-8 xl:mt-28 mb-16 max-w-prose"
    >
      <header
        class="text-left pb-10 border-b border-neutral-200 dark:border-neutral-800 mb-10"
      >
        {
          heroImage && (
            <img
              width="720"
              height="420"
              class="hero-image rounded-2xl shadow-xl mb-8 mx-auto"
              loading="lazy"
              src={heroImage}
              alt={alt}
            />
          )
        }

        {/* Tags moved to the bottom */}

        <h1
          class="text-4xl md:text-5xl font-extrabold tracking-tight mb-6 bg-clip-text text-transparent bg-linear-to-r from-neutral-900 to-neutral-600 dark:from-white dark:to-neutral-400"
        >
          {title}
        </h1>

        {/* Metadata and Author */}
        <div
          class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 text-sm text-neutral-600 dark:text-neutral-400"
        >
          <div class="flex items-center gap-3">
            <div class="flex flex-wrap items-center gap-x-2 gap-y-1 text-left">
              <a
                href="https://pavi2410.com"
                class="font-semibold text-neutral-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                >Pavitra Golchha</a
              >
              <span class="opacity-50 hidden sm:inline">&bull;</span>
              <span class="flex items-center gap-1.5 opacity-80">
                <Icon name="tabler:calendar" class="w-4 h-4" />
                {formatDate(publishDate)}
                {
                  readingTime && (
                    <>
                      <span class="w-1 h-1 rounded-full bg-current opacity-50" />
                      <Icon name="tabler:clock" class="w-4 h-4" />
                      {readingTime}
                    </>
                  )
                }
              </span>
            </div>
          </div>

          <div class="flex items-center gap-3 mt-4 sm:mt-0">
            {
              rawContent && (
                <div class="not-prose shrink-0">
                  <CopyToMarkdown client:load content={rawContent} />
                </div>
              )
            }
          </div>
        </div>

        {
          quickLinks && (
            <div class="mt-6 flex flex-wrap gap-3 not-prose pt-6 border-t border-neutral-200 dark:border-neutral-800">
              {quickLinks.map(({ title, link }) => (
                <a
                  href={link}
                  target="_blank"
                  class="group flex items-center gap-2 rounded-xl py-2 px-4 shadow-sm hover:shadow-md transition-all text-sm font-bold border border-transparent hover:border-black/5 dark:hover:border-white/10 hover:-translate-y-0.5"
                  style={pickColorByHash(title)}
                >
                  <Icon name="tabler:link" class="w-4 h-4 opacity-70" />
                  {title}
                  <Icon
                    name="tabler:external-link"
                    class="w-4 h-4 opacity-50 group-hover:opacity-100 transition-opacity ml-1"
                  />
                </a>
              ))}
            </div>
          )
        }
      </header>
      <main>
        <slot />

        <ShareButtons url={fullUrl} title={title} />

        {
          tags && tags.length > 0 && (
            <div class="mt-8 pt-8 border-t border-neutral-200 dark:border-neutral-800">
              <h3 class="text-sm font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-widest mb-4">
                Tags
              </h3>
              <div class="flex flex-wrap gap-2 not-prose">
                {tags.map((tag) => (
                  <a
                    href={`/blog/tag/${encodeURIComponent(tag)}`}
                    class="rounded-full text-xs font-semibold px-3 py-1 hover:scale-105 transition-transform shadow-xs"
                    style={pickColorByHash(tag)}
                  >
                    #{tag}
                  </a>
                ))}
              </div>
            </div>
          )
        }
      </main>
    </article>

    <!-- TOC for desktop: sticky on the right -->
    <aside class="toc-aside">
      <TableOfContents client:load headings={headings} />
    </aside>
  </div>
</BaseLayout>

<style>
  @reference "../styles/global.css";

  .blog-container {
    @apply mx-auto;
  }

  .toc-aside {
    @apply hidden;
  }

  /* Desktop xl (1280px+): center content + TOC as a group */
  @media (min-width: 1280px) {
    .blog-container {
      @apply flex justify-center gap-8 max-w-[1200px];
    }

    .toc-aside {
      @apply block sticky top-24 w-64 h-[calc(100vh-6rem)] shrink-0;
    }
  }

  /* Between lg and xl (1024px-1279px): center content only */
  @media (min-width: 1024px) and (max-width: 1279px) {
    .blog-container {
      @apply flex justify-center;
    }

    article {
      @apply mx-8;
    }
  }

  /* Scroll margin for anchor links - accounts for sticky headers */
  article :global(h2[id]),
  article :global(h3[id]),
  article :global(h4[id]) {
    /* Mobile: header (72px) + TOC bar (48px) + padding */
    scroll-margin-top: 9rem;
  }

  @media (min-width: 1280px) {
    article :global(h2[id]),
    article :global(h3[id]),
    article :global(h4[id]) {
      /* Desktop: only header (56px) + padding */
      scroll-margin-top: 5rem;
    }
  }
</style>
