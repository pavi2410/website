---
import { formatDate, getReadingTime, pickColorByHash, pickColorGradientByHash } from "@/util";
import BaseLayout from "./BaseLayout.astro";
import Header from "@/components/Header.astro";
import type { CollectionEntry } from "astro:content";
import { Icon } from "astro-icon/components";
import TableOfContents from "@/components/TableOfContents";
import CopyToMarkdown from "@/components/CopyToMarkdown";
import ShareButtons from "@/components/ShareButtons.astro";

export interface Props {
  frontmatter: CollectionEntry<"posts">["data"];
  headings?: { depth: number; slug: string; text: string; }[];
  rawContent?: string;
}

const {
  frontmatter: {
    title,
    excerpt,
    publishDate,
    quickLinks,
    tags,
  },
  rawContent,
} = Astro.props;

const permalink = Astro.url.pathname;
const fullUrl = new URL(permalink, Astro.site || 'https://pavi2410.com').href;
const heroImage = '';
const alt = '';
const keywords = tags.join(', ');
const readingTime = rawContent ? getReadingTime(rawContent) : null;

// Get headings for TOC
const headings = Astro.props.headings || [];
---

<BaseLayout
  title={title}
  description={excerpt}
  permalink={permalink}
  publishDate={publishDate}
  keywords={keywords}
  type="article"
>
  <Header />

  <!-- Mobile TOC: sticky below main header -->
  <div class="xl:hidden sticky top-14 z-40 bg-neutral-50/95 dark:bg-neutral-950/95 backdrop-blur border-b border-neutral-200 dark:border-neutral-800">
    <TableOfContents client:load headings={headings} collapsible />
  </div>

  <div class="blog-container">
    <article
      class="prose prose-lg dark:prose-invert max-lg:mx-8 my-16 max-w-prose"
    >
    <header class="text-left">
      {
        heroImage && (
          <img
            width="720"
            height="420"
            class="hero-image"
            loading="lazy"
            src={heroImage}
            alt={alt}
          />
        )
      }
      <h1 class="title">{title}</h1>
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <p>
          <a href="https://pavi2410.com">Pavitra Golchha</a> • Published on&nbsp;
          {formatDate(publishDate)}
          {readingTime && <span> · {readingTime}</span>}
        </p>
        {
          rawContent && (
            <div class="not-prose shrink-0">
              <CopyToMarkdown client:load content={rawContent} />
            </div>
          )
        }
      </div>
      <div>
        <div class="uppercase text-sm font-semibold opacity-50 pb-1">
          Tags
        </div>
        <div class="flex flex-wrap gap-1 not-prose">
          {
            tags.map((tag) => (
              <a
                href={`/blog/tag/${encodeURIComponent(tag)}`}
                class="rounded text-sm px-2.5 py-0.5"
                style={pickColorByHash(tag)}
              >
                {tag}
              </a>
            ))
          }
        </div>
      </div>
      {
        quickLinks && (
          <p>
            <div class="uppercase text-sm font-semibold opacity-50 pb-1">
              Quick Links
            </div>
            <div class="flex gap-4 not-prose overflow-x-scroll mask-r-from-95%">
              {quickLinks.map(({ title, link }) => (
                <a
                  href={link}
                  target="_blank"
                  class={`relative border rounded-xl py-2 px-4 h-32 aspect-video ${pickColorGradientByHash(title)}`}
                >
                  {title}
                  <Icon
                    name="tabler:external-link"
                    size="2rem"
                    class="absolute bottom-4 right-4"
                  />
                </a>
              ))}
            </div>
          </p>
        )
      }
    </header>
    <main>
      <slot />

      <ShareButtons url={fullUrl} title={title} />
    </main>
  </article>
  
  <!-- TOC for desktop: sticky on the right -->
  <aside class="toc-aside">
    <TableOfContents client:load headings={headings} />
  </aside>
  </div>
</BaseLayout>

<style>
  @reference "../styles/global.css";
  
  .blog-container {
    @apply mx-auto;
  }

  .toc-aside {
    @apply hidden;
  }

  /* Desktop xl (1280px+): center content + TOC as a group */
  @media (min-width: 1280px) {
    .blog-container {
      @apply flex justify-center gap-8 max-w-[1200px];
    }

    .toc-aside {
      @apply block sticky top-24 w-64 h-[calc(100vh-6rem)] shrink-0;
    }
  }

  /* Between lg and xl (1024px-1279px): center content only */
  @media (min-width: 1024px) and (max-width: 1279px) {
    .blog-container {
      @apply flex justify-center;
    }

    article {
      @apply mx-8;
    }
  }

  /* Scroll margin for anchor links - accounts for sticky headers */
  article :global(h2[id]),
  article :global(h3[id]),
  article :global(h4[id]) {
    /* Mobile: header (56px) + TOC bar (48px) + padding */
    scroll-margin-top: 7rem;
  }

  @media (min-width: 1280px) {
    article :global(h2[id]),
    article :global(h3[id]),
    article :global(h4[id]) {
      /* Desktop: only header (56px) + padding */
      scroll-margin-top: 5rem;
    }
  }
</style>
